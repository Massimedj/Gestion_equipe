<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Assistant pour la gestion de l'équipe</title>
	<link rel="icon" type="image/png" href="Images/Favicone.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Styles personnalisés */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8; /* Fond gris très clair */
        }
        .court-container::before, .court-container::after {
            content: '';
            position: absolute;
            width: 8px; /* Poteaux épais */
            height: 12px;
            background-color: #374151;
            top: 10px; /* Aligné avec le haut du terrain */
            transform: translateY(-50%); /* Centré sur la ligne du filet */
            z-index: 10;
        }
        .court-container::before {
            left: -4px;
        }
        .court-container::after {
            right: -4px;
        }
        .court {
            width: 100%;
            max-width: 400px;
            aspect-ratio: 1 / 1;
            height: auto;
            background-color: #fde68a; /* Couleur sable */
            border: 2px solid #374151;
            position: relative;
            margin: 0 auto;
            margin-top: 10px; /* Espace pour le filet */
            display: grid;
            grid-template-columns: 1fr 1fr 1fr; /* 3 joueurs en ligne */
            grid-template-rows: 1fr 1fr; /* 2 lignes */
        }
        .net {
            position: absolute;
            top: 0; /* Positionné en haut du terrain */
            left: 0;
            width: 100%;
            height: 4px; /* Filet plus visible */
            background-color: #1f2937;
            transform: translateY(-50%); /* Centré sur la bordure supérieure */
        }
        .position {
            border: 1px dashed #6b7280;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            padding: 8px;
            text-align: center;
        }
        .position-label {
            font-weight: bold;
            font-size: 0.9em;
            color: #4b5563;
        }
        .player-select {
            margin-top: 5px;
            width: 100%;
            border-radius: 4px;
            border: 1px solid #d1d5db;
            font-size: 0.8em;
        }
        .tab-button, .set-button {
            transition: all 0.3s ease;
        }
        .tab-button.active, .set-button.active {
            background-color: #3b82f6;
            color: white;
            border-color: #3b82f6;
        }
        /* Style pour les modals */
        .modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 50;
        }
        .jersey-badge {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
            background-color: #4b5563;
        }
        .captain-checkbox:checked {
            background-color: #f59e0b;
            border-color: #f59e0b;
        }
        /* Styles pour la nouvelle vue Suivi en Direct */
        #live-court-layout {
            display: grid;
            grid-template-columns: 1fr 1fr; /* Grille 2x3 */
            gap: 0.75rem;
        }
        .live-player-card {
            border: 1px solid #e5e7eb;
            border-radius: 0.75rem;
            padding: 0.75rem;
            text-align: center;
            background-color: #f9fafb;
            display: flex;
            flex-direction: column;
        }
        .player-name-display {
            line-height: 1.25rem; /* Hauteur d'une ligne de texte */
            height: 2.5rem;      /* Hauteur pour deux lignes de texte */
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .fault-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.5rem;
            margin-top: 0.75rem;
        }
        .fault-grid-btn, .simple-fault-btn {
            border-radius: 0.5rem;
            font-weight: 500;
            transition: background-color 0.2s;
            cursor: pointer;
            user-select: none; /* Empêche la sélection de texte pendant l'appui long */
            background-color: #fb923c; /* Orange clair (orange-400) */
            color: white;
            border: 1px solid #fb923c;
        }
        .fault-grid-btn {
             padding: 0.5rem 0.25rem;
             font-size: 0.8rem;
        }
        .simple-fault-btn {
            flex-grow: 1;
            margin-top: 0.75rem;
            font-size: 2.25rem;
            font-weight: 700;
            line-height: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            aspect-ratio: 1 / 1; /* Assure que le bouton est carré */
        }
        .fault-btn-active {
            background-color: #f97316 !important; /* Orange un peu plus foncé (orange-500) */
            border-color: #f97316 !important;
        }
        .fault-count {
            font-weight: 700;
            margin-left: 0.25rem;
        }
        /* Style pour l'interrupteur */
        .toggle-label {
            position: relative;
            display: inline-flex;
            align-items: center;
            cursor: pointer;
        }
        .toggle-input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .toggle-slider {
            width: 44px;
            height: 24px;
            background-color: #ccc;
            border-radius: 9999px;
            transition: background-color 0.2s;
            position: relative;
        }
        .toggle-slider::before {
            content: '';
            position: absolute;
            height: 20px;
            width: 20px;
            left: 2px;
            bottom: 2px;
            background-color: white;
            border-radius: 50%;
            transition: transform 0.2s;
        }
        .toggle-input:checked + .toggle-slider {
            background-color: #3b82f6;
        }
        .toggle-input:checked + .toggle-slider::before {
            transform: translateX(20px);
        }
    </style>
</head>
<body class="text-gray-800">

    <div class="container mx-auto p-4 md:p-8 max-w-7xl">
        <header class="text-center mb-8">
            <img src="Images/Logo_EsayPlay.png" alt="Logo EasyPlay" class="mx-auto h-20 w-auto mb-4">
            <h1 class="text-3xl sm:text-4xl font-bold text-gray-900">Assistant du Coach</h1>
            <p class="text-lg text-gray-600 mt-2">Votre outil tout-en-un pour le coaching</p>
        </header>

        <main>
             <div class="bg-white p-6 rounded-2xl shadow-lg mb-8">
                <h2 class="text-2xl font-bold mb-4 border-b pb-2">Gestion des Équipes</h2>
                <div class="flex flex-wrap items-center gap-4">
                    <select id="teamSelector" class="flex-grow p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none w-full sm:w-auto">
                        </select>
                    <div class="flex gap-2 w-full sm:w-auto">
                        <button onclick="openAddTeamModal()" class="flex-1 bg-indigo-500 text-white font-semibold py-2 px-3 rounded-lg hover:bg-indigo-600 transition">Nouvelle</button>
                        <div id="teamActions" class="flex-1 flex gap-2 hidden">
                            <button onclick="openEditTeamModal()" class="w-full bg-yellow-500 text-white font-semibold py-2 px-3 rounded-lg hover:bg-yellow-600 transition">Modifier</button>
                            <button onclick="deleteCurrentTeam()" class="w-full bg-red-600 text-white font-semibold py-2 px-3 rounded-lg hover:bg-red-700 transition">Supprimer</button>
                        </div>
                    </div>
                </div>
            </div>

            <div id="team-content" class="hidden">
                <div class="mb-8">
					<nav class="-mb-px flex space-x-4 sm:space-x-8 overflow-x-auto border-b border-gray-200" aria-label="Tabs">
                        <button id="main-tab-roster" onclick="showMainTab('roster')" class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-lg">
                            Effectif
                        </button>
                        <button id="main-tab-matches" onclick="showMainTab('matches')" class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-lg">
                            Matchs
                        </button>
                        <button id="main-tab-live" onclick="showMainTab('live')" class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-lg">
                            Fautes
                        </button>
                         <button id="main-tab-results" onclick="showMainTab('results')" class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-lg">
                            Résultats
                        </button>
                        <button id="main-tab-stats" onclick="showMainTab('stats')" class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-lg">
                            Statistiques
                        </button>
                    </nav>
                </div>

                <div id="main-view-roster">
                    <div class="bg-white p-6 rounded-2xl shadow-lg mb-8">
                        <h2 class="text-2xl font-bold mb-4 border-b pb-2">Effectif de l'équipe</h2>
                        <button onclick="openAddPlayerModal()" class="w-full bg-blue-500 text-white font-semibold py-3 px-6 rounded-lg hover:bg-blue-600 transition duration-300 shadow mb-6">Ajouter un joueur</button>

                        <div id="playerList" class="mt-6 space-y-2">
                            </div>
                        <button id="deleteAllPlayersBtn" onclick="deleteAllPlayers()" class="w-full mt-4 bg-red-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-red-700 transition hidden">Supprimer l'effectif</button>
                    </div>
                </div>
                
                <div id="main-view-matches" class="hidden">
                    <div class="bg-white p-6 rounded-2xl shadow-lg mb-8">
                        <h2 class="text-2xl font-bold mb-4 border-b pb-2">Gestion des Matchs</h2>
                        <button onclick="openAddMatchModal()" class="w-full bg-green-500 text-white font-semibold py-3 px-6 rounded-lg hover:bg-green-600 transition duration-300 shadow mb-6">Ajouter une rencontre</button>
                        
                        <h3 class="text-xl font-semibold mb-3 border-t pt-6">Sélectionner un match</h3>
                        <select id="matchSelector" class="w-full p-3 border border-gray-300 rounded-lg mb-2 focus:ring-2 focus:ring-blue-500 focus:outline-none">
                            </select>
                        <p id="match-hint" class="text-sm text-gray-500 -mt-1 mb-2">Sélectionnez un match pour le gérer.</p>
                        <div id="matchActions" class="hidden flex gap-2 mb-4">
                            <button onclick="openEditMatchModal()" class="flex-1 bg-yellow-500 text-white text-sm font-semibold py-2 px-4 rounded-lg hover:bg-yellow-600 transition">Modifier</button>
                            <button onclick="deleteSelectedMatch()" class="flex-1 bg-red-500 text-white text-sm font-semibold py-2 px-4 rounded-lg hover:bg-red-600 transition">Supprimer</button>
                        </div>
                    </div>
                    
                    <div id="selectedMatchContent" class="hidden space-y-8">
                        <div class="bg-white p-6 rounded-2xl shadow-lg">
                             <h3 class="text-xl font-semibold mb-3">Feuille de Match</h3>
                             <div id="attendanceList" class="space-y-2">
                                </div>
                        </div>

                        <div class="bg-white p-6 rounded-2xl shadow-lg">
                            <h3 class="text-xl font-semibold mb-4 text-center">Composition par Set</h3>
                             <div id="set-selector-matches" class="flex justify-center gap-1 mb-4 rounded-lg bg-gray-200 p-1">
                                </div>
                            <div class="court-container relative">
                               <div class="court">
                                   <div class="net"></div>
                                   <div id="pos-4" class="position"><span class="position-label">P4</span></div>
                                   <div id="pos-3" class="position"><span class="position-label">P3</span></div>
                                   <div id="pos-2" class="position"><span class="position-label">P2</span></div>
                                   <div id="pos-5" class="position"><span class="position-label">P5</span></div>
                                   <div id="pos-6" class="position"><span class="position-label">P6</span></div>
                                   <div id="pos-1" class="position"><span class="position-label">P1</span></div>
                               </div>
                            </div>
                            <div id="substitutions-tracker" class="mt-6">
                                <h4 class="font-semibold text-lg mb-2">Remplacements pour ce Set</h4>
                                <div id="substitutionsList" class="space-y-2">
                                    </div>
                            </div>
                        </div>

                        <div class="bg-white p-6 rounded-2xl shadow-lg">
                            <h3 class="text-xl font-semibold mb-3">Score du Match</h3>
                            <div class="space-y-4">
                                <div class="p-3 bg-gray-100 rounded-lg">
                                    <div class="grid grid-cols-3 items-center gap-2 text-center mb-2">
                                        <label id="myTeamNameLabel" class="font-semibold break-all"></label>
                                        <div></div>
                                        <label id="opponentNameLabel" class="font-semibold break-all"></label>
                                    </div>
                                    <div class="grid grid-cols-3 items-center gap-2 text-center">
                                        <input type="number" id="scoreMyTeam" class="w-full p-2 border border-gray-300 rounded-lg text-center font-bold text-lg bg-gray-200" disabled>
                                        <span class="font-bold text-lg">-</span>
                                        <input type="number" id="scoreOpponent" class="w-full p-2 border border-gray-300 rounded-lg text-center font-bold text-lg bg-gray-200" disabled>
                                    </div>
                                </div>
                                <div id="setScoresContainer" class="space-y-2">
                                    </div>
                                <div id="forfeit-controls" class="mt-4 pt-4 border-t">
                                    <p id="forfeit-status-display" class="hidden text-center font-semibold mb-2"></p>
                                    <div id="forfeit-buttons" class="flex gap-2">
                                        <button onclick="setForfeit('win')" class="flex-1 bg-green-500 text-white text-sm font-semibold py-2 px-4 rounded-lg hover:bg-green-600">Victoire par Forfait</button>
                                        <button onclick="setForfeit('loss')" class="flex-1 bg-red-500 text-white text-sm font-semibold py-2 px-4 rounded-lg hover:bg-red-600">Défaite par Forfait</button>
                                    </div>
                                    <button id="cancel-forfeit-button" onclick="setForfeit('none')" class="hidden w-full bg-gray-500 text-white text-sm font-semibold py-2 px-4 rounded-lg hover:bg-gray-600">Annuler le Forfait</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="main-view-live" class="hidden">
                    <div class="bg-white p-4 md:p-6 rounded-2xl shadow-lg">
                        <div class="flex justify-between items-center mb-4 border-b pb-2">
                            <h2 class="text-2xl font-bold">Suivi de Fautes Directes</h2>
                            <div class="flex items-center gap-2">
                                <span class="text-sm font-medium text-gray-700">Suivi Détaillé</span>
                                <label class="toggle-label">
                                    <input type="checkbox" id="fault-mode-toggle" class="toggle-input">
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                        </div>

                        <div id="live-match-display" class="hidden my-4 p-3 bg-gray-100 rounded-lg sm:flex items-center justify-between gap-4">
                            <div class="text-sm">
                                <span class="font-semibold">Match&nbsp;:</span>
                                <span id="live-match-name"></span>
                            </div>
                            <button onclick="showMainTab('matches')" class="bg-blue-500 text-white text-xs font-semibold py-1 px-3 rounded-lg hover:bg-blue-600 transition-colors flex-shrink-0">Changer</button>
                        </div>
                        
                        <p id="live-match-hint" class="text-gray-600 my-4">Veuillez d'abord sélectionner un match dans l'onglet "Matchs".</p>
                        
                        <div id="live-content" class="hidden">
                            <div id="set-selector-live" class="flex justify-center gap-1 mb-4 rounded-lg bg-gray-200 p-1">
                                </div>
                            
                            <div id="live-court-layout" class="mt-4">
                                </div>
                            <div class="mt-4 text-center">
                                <button id="undo-last-fault" class="bg-gray-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-gray-600 transition text-sm">Annuler la dernière faute</button>
                            </div>
                            
                            <div id="set-faults-summary" class="mt-6 border-t pt-4">
                                </div>
                        </div>
                    </div>
                </div>
                
                <div id="main-view-results" class="hidden">
                    <div class="bg-white p-6 rounded-2xl shadow-lg">
                        <h2 class="text-2xl font-bold mb-4 border-b pb-2">Résultats de la Saison</h2>
                        <div id="results-summary" class="text-center mb-6 p-4 bg-gray-100 rounded-lg">
                            </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-left table-auto text-sm border-collapse">
                                <thead class="bg-gray-100">
                                    <tr>
                                        <th class="p-2 font-semibold">Date</th>
                                        <th class="p-2 font-semibold">Adversaire</th>
                                        <th class="p-2 font-semibold text-center">Lieu</th>
                                        <th class="p-2 font-semibold text-center">Résultat</th>
                                        <th class="p-2 font-semibold whitespace-nowrap">Score des Sets</th>
                                    </tr>
                                </thead>
                                <tbody id="results-list-table">
								</tbody>

                            </table>
                        </div>
                    </div>
                </div>

                <div id="main-view-stats" class="hidden">
                    <div class="bg-white p-6 rounded-2xl shadow-lg mb-8">
                        <h3 class="text-2xl font-bold mb-4 border-b pb-2">Résultats de l'équipe</h3>
                        <div class="overflow-x-auto">
                            <table class="w-full text-left table-auto text-sm">
                                <thead class="bg-gray-100">
                                    <tr>
                                        <th class="p-2 font-semibold text-center">Pts</th>
                                        <th class="p-2 font-semibold text-center">Joués</th>
                                        <th class="p-2 font-semibold text-center text-green-600">Gagnés</th>
                                        <th class="p-2 font-semibold text-center text-red-600">Perdus</th>
                                        <th class="p-2 font-semibold text-center text-green-600 whitespace-nowrap">3-0</th>
                                        <th class="p-2 font-semibold text-center text-green-600 whitespace-nowrap">3-1</th>
                                        <th class="p-2 font-semibold text-center text-green-600 whitespace-nowrap">3-2</th>
                                        <th class="p-2 font-semibold text-center text-red-600 whitespace-nowrap">2-3</th>
                                        <th class="p-2 font-semibold text-center text-red-600 whitespace-nowrap">1-3</th>
                                        <th class="p-2 font-semibold text-center text-red-600 whitespace-nowrap">0-3</th>
                                        <th class="p-2 font-semibold text-center text-green-600 whitespace-nowrap">Set P.</th>
                                        <th class="p-2 font-semibold text-center text-red-600 whitespace-nowrap">Set C.</th>
                                        <th class="p-2 font-semibold text-center text-green-600 whitespace-nowrap">Pts P.</th>
                                        <th class="p-2 font-semibold text-center text-red-600 whitespace-nowrap">Pts C.</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr id="teamStatsRow" class="font-mono text-center">
                                        </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div class="bg-white p-6 rounded-2xl shadow-lg">
                        <h3 class="text-2xl font-bold mb-4 border-b pb-2">Statistiques des Joueurs</h3>
                        <div class="overflow-x-auto">
                            <table class="w-full text-left table-auto text-sm border-collapse">
                                <thead class="bg-gray-100">
                                    <tr>
                                        <th class="p-2 font-semibold">Joueur</th>
                                        <th class="p-2 font-semibold text-center">Présences</th>
                                        <th class="p-2 font-semibold text-center">Matchs Joués</th>
                                        <th class="p-2 font-semibold text-center">Sets Joués</th>
                                        <th class="p-2 font-semibold text-center">Sets Gagnés</th>
                                        <th class="p-2 font-semibold text-center text-red-600">F. Service</th>
                                        <th class="p-2 font-semibold text-center text-red-600">F. Attaque</th>
                                        <th class="p-2 font-semibold text-center text-red-600">F. Récep.</th>
                                        <th class="p-2 font-semibold text-center text-red-600">Autres F.</th>
                                        <th class="p-2 font-semibold text-center">Total Fautes</th>
                                    </tr>
                                </thead>
                                <tbody id="statsTableBody">
                                    </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </main>
        <footer class="text-center text-gray-500 text-sm py-8">
            <p>© 2025 EasyPlay. Tous droits réservés. Fait par Massi ⵣ. Pour toute question, contactez-moi à contact.easyplayapp@gmail.com.</p>
        </footer>
    </div>

    <div id="addPlayerModal" class="modal-backdrop hidden">
        <div class="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-lg mx-4 sm:mx-0">
            <h2 class="text-2xl font-bold mb-4">Ajouter un joueur</h2>
            <div class="space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="flex flex-col md:col-span-2">
                        <label for="newPlayerName" class="font-semibold mb-1">Nom du joueur</label>
                        <input type="text" id="newPlayerName" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none" placeholder="Prénom Nom...">
                    </div>
                     <div class="flex flex-col">
                        <label for="newLicenseNumber" class="font-semibold mb-1">N° de Licence</label>
                        <input type="text" id="newLicenseNumber" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none" placeholder="Ex: 1234567">
                    </div>
                    <div class="flex flex-col">
                        <label for="newJerseyNumber" class="font-semibold mb-1">N° de Maillot</label>
                        <input type="number" id="newJerseyNumber" min="0" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none" placeholder="Ex: 10">
                    </div>
                    <div class="flex flex-col">
                        <label class="font-semibold mb-1">Genre</label>
                        <div class="flex gap-4 p-3 bg-gray-50 rounded-lg border border-gray-300 h-[50px] items-center">
                            <label><input type="radio" name="gender" value="H" checked> Garçon</label>
                            <label><input type="radio" name="gender" value="F"> Fille</label>
                        </div>
                    </div>
                     <div class="flex flex-col">
                        <label for="newPlayerMainPosition" class="font-semibold mb-1">Poste 1 (principal)</label>
                        <select id="newPlayerMainPosition" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none"></select>
                    </div>
                    <div class="flex flex-col md:col-span-2">
                        <label for="newPlayerSecondaryPosition" class="font-semibold mb-1">Poste 2 (secondaire)</label>
                        <select id="newPlayerSecondaryPosition" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none"></select>
                    </div>
                </div>
            </div>
            <div class="flex justify-end gap-4 mt-6">
                <button onclick="closeModal('addPlayerModal')" class="bg-gray-300 text-gray-800 font-semibold py-2 px-6 rounded-lg hover:bg-gray-400">Annuler</button>
                <button onclick="addPlayer()" class="bg-blue-500 text-white font-semibold py-2 px-6 rounded-lg hover:bg-blue-600">Ajouter</button>
            </div>
        </div>
    </div>
    <div id="addMatchModal" class="modal-backdrop hidden">
        <div class="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-lg mx-4 sm:mx-0">
            <h2 class="text-2xl font-bold mb-4">Ajouter une rencontre</h2>
            <div class="space-y-4">
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <input type="date" id="matchDate" class="p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none">
                    <input type="text" id="opponentName" placeholder="Nom de l'adversaire" class="p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none">
                </div>
                <div class="flex flex-col">
                    <label class="font-semibold mb-1">Lieu du match</label>
                    <div class="flex gap-4 p-3 bg-gray-50 rounded-lg border border-gray-300 items-center">
                        <label><input type="radio" name="matchLocation" value="domicile" checked> Domicile</label>
                        <label><input type="radio" name="matchLocation" value="exterieur"> Extérieur</label>
                    </div>
                </div>
            </div>
            <div class="flex justify-end gap-4 mt-6">
                <button onclick="closeModal('addMatchModal')" class="bg-gray-300 text-gray-800 font-semibold py-2 px-6 rounded-lg hover:bg-gray-400">Annuler</button>
                <button onclick="createMatch()" class="bg-green-500 text-white font-semibold py-2 px-6 rounded-lg hover:bg-green-600">Créer</button>
            </div>
        </div>
    </div>
    <div id="addTeamModal" class="modal-backdrop hidden">
        <div class="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-lg mx-4 sm:mx-0">
            <h2 class="text-2xl font-bold mb-4">Ajouter une nouvelle équipe</h2>
            <div class="space-y-4">
                <div>
                    <label for="newTeamName" class="font-semibold mb-1 block">Nom de l'équipe</label>
                    <input type="text" id="newTeamName" class="w-full p-3 border border-gray-300 rounded-lg" placeholder="Ex: Régional Senior Masculin">
                </div>
                <div>
                    <label for="newTeamSeason" class="font-semibold mb-1 block">Saison</label>
                    <input type="text" id="newTeamSeason" class="w-full p-3 border border-gray-300 rounded-lg" placeholder="Ex: 2025/2026">
                </div>
            </div>
            <div class="flex justify-end gap-4 mt-6">
                <button onclick="closeModal('addTeamModal')" class="bg-gray-300 text-gray-800 font-semibold py-2 px-6 rounded-lg hover:bg-gray-400">Annuler</button>
                <button onclick="addTeam()" class="bg-blue-500 text-white font-semibold py-2 px-6 rounded-lg hover:bg-blue-600">Créer</button>
            </div>
        </div>
    </div>
    
    <div id="editTeamModal" class="modal-backdrop hidden">
        <div class="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-lg mx-4 sm:mx-0">
            <h2 class="text-2xl font-bold mb-4">Modifier l'équipe</h2>
             <div class="space-y-4">
                <div>
                    <label for="editTeamName" class="font-semibold mb-1 block">Nom de l'équipe</label>
                    <input type="text" id="editTeamName" class="w-full p-3 border border-gray-300 rounded-lg">
                </div>
                <div>
                    <label for="editTeamSeason" class="font-semibold mb-1 block">Saison</label>
                    <input type="text" id="editTeamSeason" class="w-full p-3 border border-gray-300 rounded-lg">
                </div>
            </div>
            <div class="flex justify-end gap-4 mt-6">
                <button onclick="closeModal('editTeamModal')" class="bg-gray-300 text-gray-800 font-semibold py-2 px-6 rounded-lg hover:bg-gray-400">Annuler</button>
                <button onclick="saveTeamChanges()" class="bg-blue-500 text-white font-semibold py-2 px-6 rounded-lg hover:bg-blue-600">Sauvegarder</button>
            </div>
        </div>
    </div>

    <div id="editPlayerModal" class="modal-backdrop hidden">
        <div class="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-lg mx-4 sm:mx-0">
            <h2 class="text-2xl font-bold mb-4">Modifier le joueur</h2>
            <input type="hidden" id="editPlayerId">
            <div class="space-y-4">
                <input type="text" id="editPlayerName" class="w-full p-3 border border-gray-300 rounded-lg">
                <div class="grid grid-cols-2 gap-4">
                     <div class="flex flex-col">
                        <label for="editLicenseNumber" class="font-semibold mb-1">N° de Licence</label>
                        <input type="text" id="editLicenseNumber" class="w-full p-3 border border-gray-300 rounded-lg">
                    </div>
                    <div class="flex flex-col">
                        <label for="editJerseyNumber" class="font-semibold mb-1">N° de Maillot</label>
                        <input type="number" id="editJerseyNumber" min="0" class="w-full p-3 border border-gray-300 rounded-lg">
                    </div>
                </div>
                 <div>
                    <div class="flex gap-4 p-3 bg-gray-50 rounded-lg">
                        <label><input type="radio" name="editGender" value="H"> Garçon</label>
                        <label><input type="radio" name="editGender" value="F"> Fille</label>
                    </div>
                </div>
                 <div class="flex flex-col">
                    <label for="editPlayerMainPosition" class="font-semibold mb-1">Poste 1 (principal)</label>
                    <select id="editPlayerMainPosition" class="w-full p-3 border border-gray-300 rounded-lg"></select>
                </div>
                <div class="flex flex-col">
                    <label for="editPlayerSecondaryPosition" class="font-semibold mb-1">Poste 2 (secondaire)</label>
                    <select id="editPlayerSecondaryPosition" class="w-full p-3 border border-gray-300 rounded-lg"></select>
                </div>
                <div class="flex justify-end gap-4">
                    <button onclick="closeModal('editPlayerModal')" class="bg-gray-300 text-gray-800 font-semibold py-2 px-6 rounded-lg hover:bg-gray-400">Annuler</button>
                    <button onclick="savePlayerChanges()" class="bg-blue-500 text-white font-semibold py-2 px-6 rounded-lg hover:bg-blue-600">Sauvegarder</button>
                </div>
            </div>
        </div>
    </div>
    
    <div id="editMatchModal" class="modal-backdrop hidden">
        <div class="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-lg mx-4 sm:mx-0">
            <h2 class="text-2xl font-bold mb-4">Modifier le match</h2>
            <input type="hidden" id="editMatchId">
            <div class="space-y-4">
                 <input type="date" id="editMatchDate" class="w-full p-3 border border-gray-300 rounded-lg">
                 <input type="text" id="editOpponentName" class="w-full p-3 border border-gray-300 rounded-lg">
                 <div class="flex flex-col">
                    <label class="font-semibold mb-1">Lieu du match</label>
                    <div class="flex gap-4 p-3 bg-gray-50 rounded-lg border border-gray-300 items-center">
                        <label><input type="radio" name="editMatchLocation" value="domicile"> Domicile</label>
                        <label><input type="radio" name="editMatchLocation" value="exterieur"> Extérieur</label>
                    </div>
                </div>
                <div class="flex justify-end gap-4">
                    <button onclick="closeModal('editMatchModal')" class="bg-gray-300 text-gray-800 font-semibold py-2 px-6 rounded-lg hover:bg-gray-400">Annuler</button>
                    <button onclick="saveMatchChanges()" class="bg-blue-500 text-white font-semibold py-2 px-6 rounded-lg hover:bg-blue-600">Sauvegarder</button>
                </div>
            </div>
        </div>
    </div>

    <div id="substitutionModal" class="modal-backdrop hidden">
        <div class="bg-white p-6 rounded-2xl shadow-2xl w-full max-w-sm mx-4 sm:mx-0">
            <h2 id="substitutionModalTitle" class="text-xl font-bold mb-4">Remplacer un joueur</h2>
            <div id="substitutesList" class="space-y-2 max-h-60 overflow-y-auto">
                </div>
            <div class="flex justify-end gap-4 mt-6">
                <button onclick="closeModal('substitutionModal')" class="bg-gray-300 text-gray-800 font-semibold py-2 px-6 rounded-lg hover:bg-gray-400">Annuler</button>
            </div>
        </div>
    </div>


    <script>
        const POSITIONS = ['Passeur', 'Central', 'R\u00e9ceptionneur-Attaquant', 'Pointu', 'Lib\u00e9ro'];
        const SETS = ['set1', 'set2', 'set3', 'set4', 'set5'];

        // --- STRUCTURE DES DONNÉES ---
        let appData = { teams: [], currentTeamId: null, lastFaultAction: null };
        let currentSet = 'set1';

        // --- GESTION DES ONGLETS & VUES ---
        function showMainTab(tabName) {
			localStorage.setItem('lastActiveTab', tabName);
            document.getElementById('main-view-roster').classList.add('hidden');
            document.getElementById('main-view-matches').classList.add('hidden');
            document.getElementById('main-view-stats').classList.add('hidden');
            document.getElementById('main-view-live').classList.add('hidden');
            document.getElementById('main-view-results').classList.add('hidden');
            
            const tabs = ['roster', 'matches', 'stats', 'live', 'results'];
            tabs.forEach(t => {
                const tabButton = document.getElementById(`main-tab-${t}`);
                if (tabButton) {
                    tabButton.classList.remove('border-indigo-500', 'text-indigo-600');
                    tabButton.classList.add('border-transparent', 'text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300');
                }
            });

            document.getElementById(`main-view-${tabName}`).classList.remove('hidden');
            const activeButton = document.getElementById(`main-tab-${tabName}`);
            activeButton.classList.add('border-indigo-500', 'text-indigo-600');
            activeButton.classList.remove('border-transparent', 'text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300');

            if (tabName === 'stats') {
                renderStats();
            }
            if (tabName === 'live') {
                renderLiveTrackingView();
            }
             if (tabName === 'results') {
                renderResults();
            }
        }
        
        function selectSet(setName) {
            currentSet = setName;
            appData.lastFaultAction = null; // Réinitialiser l'annulation en changeant de set
            renderSetSelector();
            renderCourt();
            renderSubstitutions();
            renderLiveTrackingView();
        }

        // --- GESTION DES MODALS ---
        function openAddPlayerModal() {
            document.getElementById('addPlayerModal').classList.remove('hidden');
        }

        function openAddMatchModal() {
            document.getElementById('addMatchModal').classList.remove('hidden');
        }

        function openAddTeamModal() {
            document.getElementById('newTeamName').value = '';
            const currentYear = new Date().getFullYear();
            document.getElementById('newTeamSeason').value = `${currentYear}/${currentYear + 1}`;
            document.getElementById('addTeamModal').classList.remove('hidden');
        }

        function openEditTeamModal() {
            const currentTeam = getCurrentTeam();
            if (!currentTeam) return;
            document.getElementById('editTeamName').value = currentTeam.name;
            document.getElementById('editTeamSeason').value = currentTeam.season || '';
            document.getElementById('editTeamModal').classList.remove('hidden');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.add('hidden');
        }

        // --- LOGIQUE DE L'APPLICATION ---
document.addEventListener('DOMContentLoaded', () => {
    loadData();
    renderTeamSelector();
    populatePositionSelects();

    document.getElementById('teamSelector').addEventListener('change', (e) => {
        const teamSelected = !!e.target.value;
        document.getElementById('teamActions').classList.toggle('hidden', !teamSelected);
        switchTeam(parseInt(e.target.value));
    });

    document.getElementById('matchSelector').addEventListener('change', (e) => {
        const matchSelected = !!e.target.value;
        localStorage.setItem(`lastSelectedMatch_${appData.currentTeamId}`, e.target.value);
        document.getElementById('matchActions').classList.toggle('hidden', !matchSelected);
        document.getElementById('match-hint').classList.toggle('hidden', matchSelected);
        document.getElementById('selectedMatchContent').classList.toggle('hidden', !matchSelected);
        selectSet('set1'); 
        renderAttendanceForSelectedMatch();
        renderLiveTrackingView();
    });

    renderAllForCurrentTeam(); 
});

        function renderAllForCurrentTeam() {
            const teamExists = !!getCurrentTeam();
            document.getElementById('team-content').classList.toggle('hidden', !teamExists);
            document.getElementById('teamActions').classList.toggle('hidden', !teamExists);

            if (teamExists) {
                renderPlayerList();
                renderMatchSelector();
                renderSetSelector();
                renderAttendanceForSelectedMatch();
                const lastTab = localStorage.getItem('lastActiveTab') || 'roster';
				showMainTab(lastTab);

                const savedMatchId = localStorage.getItem(`lastSelectedMatch_${appData.currentTeamId}`);
                if (savedMatchId) {
                    const selector = document.getElementById('matchSelector');
                    // On vérifie que le match existe toujours dans la liste
                    if (selector.querySelector(`option[value="${savedMatchId}"]`)) {
                        selector.value = savedMatchId;
                        selector.dispatchEvent(new Event('change')); // On simule un clic pour tout afficher
                    }
                }        
            }
        }
        
        function populatePositionSelects() {
            const selects = [
                document.getElementById('addPlayerModal').querySelector('#newPlayerMainPosition'),
                document.getElementById('addPlayerModal').querySelector('#newPlayerSecondaryPosition'),
                document.getElementById('editPlayerModal').querySelector('#editPlayerMainPosition'),
                document.getElementById('editPlayerModal').querySelector('#editPlayerSecondaryPosition'),
            ];
            
            selects.forEach(select => {
                select.innerHTML = '';
                if (select.id.includes('Secondary')) {
                    select.innerHTML += `<option value="">Aucun</option>`;
                }
                POSITIONS.forEach(pos => {
                    select.innerHTML += `<option value="${pos}">${pos}</option>`;
                });
            });
        }

        function saveData() {
            localStorage.setItem('volleyAppData', JSON.stringify(appData));
        }

        function loadData() {
            const savedData = localStorage.getItem('volleyAppData');
            if (savedData) {
                try {
                    appData = JSON.parse(savedData);
                } catch (e) {
                    console.error("Erreur de parsing du JSON depuis localStorage:", e);
                    appData = { teams: [], currentTeamId: null, lastFaultAction: null };
                    return;
                }

                // --- Logique de migration des données ---
                if (appData.teams) {
                    appData.teams.forEach(team => {
                         if (typeof team.season === 'undefined') {
                            team.season = ''; 
                        }
                        if (team.matches) {
                            team.matches.forEach(match => {
                                if (typeof match.forfeitStatus === 'undefined') {
                                    match.forfeitStatus = 'none';
                                }
                                if (typeof match.faultTrackingMode === 'undefined') {
                                    match.faultTrackingMode = 'detailed';
                                }
                            });
                        }
                    });
                }
                if (typeof appData.lastFaultAction === 'undefined') {
                    appData.lastFaultAction = null;
                }
            }
        }

        // --- GESTION D'ÉQUIPE ---
        function getCurrentTeam() {
            if (!appData.teams) return null;
            return appData.teams.find(t => t.id === appData.currentTeamId);
        }

        function addTeam() {
            const teamName = document.getElementById('newTeamName').value.trim();
            const teamSeason = document.getElementById('newTeamSeason').value.trim();
            if(teamName) {
                const newTeam = {
                    id: Date.now(),
                    name: teamName,
                    season: teamSeason,
                    players: [],
                    matches: [],
                    courtPositions: {}
                };
                if (!appData.teams) appData.teams = [];
                appData.teams.push(newTeam);
                switchTeam(newTeam.id);
                closeModal('addTeamModal');
            }
        }

        function saveTeamChanges() {
            const currentTeam = getCurrentTeam();
            if (!currentTeam) return;
            const newName = document.getElementById('editTeamName').value.trim();
            const newSeason = document.getElementById('editTeamSeason').value.trim();
            if (newName) {
                currentTeam.name = newName;
                currentTeam.season = newSeason;
                saveData();
                renderTeamSelector();
                closeModal('editTeamModal');
            }
        }

        function deleteCurrentTeam() {
            const currentTeam = getCurrentTeam();
            if (!currentTeam) return;
            if (confirm(`Êtes-vous sûr de vouloir supprimer l'équipe "${currentTeam.name}" ? Cette action est irréversible et supprimera tous les joueurs et matchs associés.`)) {
                appData.teams = appData.teams.filter(t => t.id !== currentTeam.id);
                appData.currentTeamId = appData.teams.length > 0 ? appData.teams[0].id : null;
                saveData();
                renderTeamSelector();
                renderAllForCurrentTeam();
            }
        }

        function switchTeam(teamId) {
            appData.currentTeamId = teamId;
            saveData();
            renderTeamSelector();
            renderAllForCurrentTeam();
        }

        function renderTeamSelector() {
            const selector = document.getElementById('teamSelector');
            selector.innerHTML = '';
            if (!appData.teams || appData.teams.length === 0) {
                selector.innerHTML = '<option value="">Créez une équipe pour commencer</option>';
            } else {
                appData.teams.forEach(team => {
                    const option = document.createElement('option');
                    option.value = team.id;
                    option.textContent = team.name; // On affiche que le nom
                    selector.appendChild(option);
                });
            }
            selector.value = appData.currentTeamId;
        }


        // --- GESTION DES JOUEURS ---
        function addPlayer() {
            const currentTeam = getCurrentTeam();
            if (!currentTeam) return;
            const modal = document.getElementById('addPlayerModal');
            const name = modal.querySelector('#newPlayerName').value.trim();
            const licenseNumber = modal.querySelector('#newLicenseNumber').value.trim();
            const jerseyNumber = modal.querySelector('#newJerseyNumber').value.trim();
            const gender = modal.querySelector('input[name="gender"]:checked').value;
            const mainPosition = modal.querySelector('#newPlayerMainPosition').value;
            const secondaryPosition = modal.querySelector('#newPlayerSecondaryPosition').value;

            if (name) {
                if (currentTeam.players.some(p => p.name.toLowerCase() === name.toLowerCase())) {
                    alert('Ce joueur existe déjà.'); return;
                }
                if (jerseyNumber && currentTeam.players.some(p => p.jerseyNumber === jerseyNumber)) {
                    alert('Ce numéro de maillot est déjà pris.'); return;
                }
                currentTeam.players.push({ id: Date.now(), name, licenseNumber, jerseyNumber, gender, mainPosition, secondaryPosition });
                
                modal.querySelector('#newPlayerName').value = '';
                modal.querySelector('#newLicenseNumber').value = '';
                modal.querySelector('#newJerseyNumber').value = '';
                modal.querySelector('#newPlayerMainPosition').value = POSITIONS[0];
                modal.querySelector('#newPlayerSecondaryPosition').value = '';

                saveData();
                renderPlayerList();
                closeModal('addPlayerModal');
            }
        }
        
        function openEditPlayerModal(playerId) {
            const player = getCurrentTeam().players.find(p => p.id === playerId);
            if (!player) return;
            document.getElementById('editPlayerId').value = player.id;
            document.getElementById('editPlayerName').value = player.name;
            document.getElementById('editLicenseNumber').value = player.licenseNumber || '';
            document.getElementById('editJerseyNumber').value = player.jerseyNumber || '';
            document.querySelector(`input[name="editGender"][value="${player.gender}"]`).checked = true;
            document.getElementById('editPlayerMainPosition').value = player.mainPosition || '';
            document.getElementById('editPlayerSecondaryPosition').value = player.secondaryPosition || '';
            document.getElementById('editPlayerModal').classList.remove('hidden');
        }

        function savePlayerChanges() {
            const currentTeam = getCurrentTeam();
            const playerId = parseInt(document.getElementById('editPlayerId').value);
            const newJerseyNumber = document.getElementById('editJerseyNumber').value.trim();
            const player = currentTeam.players.find(p => p.id === playerId);
            if (!player) return;
            
            if (newJerseyNumber && currentTeam.players.some(p => p.id !== playerId && p.jerseyNumber === newJerseyNumber)) {
                alert('Ce numéro de maillot est déjà pris par un autre joueur.');
                return;
            }

            player.name = document.getElementById('editPlayerName').value.trim();
            player.licenseNumber = document.getElementById('editLicenseNumber').value.trim();
            player.jerseyNumber = newJerseyNumber;
            player.gender = document.querySelector('input[name="editGender"]:checked').value;
            player.mainPosition = document.getElementById('editPlayerMainPosition').value;
            player.secondaryPosition = document.getElementById('editPlayerSecondaryPosition').value;
            
            saveData();
            renderPlayerList();
            renderAttendanceForSelectedMatch();
            closeModal('editPlayerModal');
        }

function deletePlayer(playerId) {
    const currentTeam = getCurrentTeam();
    if (confirm('Voulez-vous vraiment supprimer ce joueur ? Il sera retiré de tous les matchs.')) {
        // 1. Supprime le joueur de la liste de l'effectif
        currentTeam.players = currentTeam.players.filter(p => p.id !== playerId);

        // 2. Nettoie sa présence, son statut de capitaine et ses positions sur le terrain dans tous les matchs
        currentTeam.matches.forEach(match => {
            // Retire le joueur de la liste des présents
            match.present = match.present.filter(id => id !== playerId);
            
            // Le destitue de son rôle de capitaine si nécessaire
            if (match.captainId === playerId) {
                match.captainId = null;
            }

            // Supprime le joueur de toutes les compositions de sets pour ce match
            if (currentTeam.courtPositions[match.id]) {
                Object.values(currentTeam.courtPositions[match.id]).forEach(setPositions => {
                    for (const pos in setPositions) {
                        if (setPositions[pos] === playerId) {
                            delete setPositions[pos];
                        }
                    }
                });
            }
        });

        saveData();
        renderPlayerList();
        renderAttendanceForSelectedMatch(); // Rafraîchit l'affichage du match en cours
        renderStats();
    }
}
        
        function deleteAllPlayers() {
            const currentTeam = getCurrentTeam();
            if (currentTeam.players.length > 0 && confirm("Êtes-vous sûr de vouloir supprimer TOUS les joueurs ? Cette action est irréversible et les retirera de tous les matchs.")) {
                currentTeam.players = [];
                currentTeam.matches.forEach(match => {
                    match.present = [];
                    match.played = [];
                });
                currentTeam.courtPositions = {};
                saveData();
                renderPlayerList();
                renderAttendanceForSelectedMatch();
                renderStats();
                renderCourt();
            }
        }

        function renderPlayerList() {
            const currentTeam = getCurrentTeam();
            const playerListDiv = document.getElementById('playerList');
            document.getElementById('deleteAllPlayersBtn').classList.toggle('hidden', currentTeam.players.length === 0);
            playerListDiv.innerHTML = currentTeam.players.length ? '' : '<p class="text-gray-500">Aucun joueur dans l\'effectif.</p>';
            const sortedPlayers = [...currentTeam.players].sort((a, b) => a.name.localeCompare(b.name));

            sortedPlayers.forEach(player => {
                const playerDiv = document.createElement('div');
                const genderClass = player.gender === 'F' ? 'bg-pink-100' : 'bg-blue-100';
                playerDiv.className = `flex flex-col sm:flex-row sm:justify-between sm:items-center ${genderClass} p-3 rounded-lg`;
                let positionsText = `P1: ${player.mainPosition || 'N/A'}`;
                if (player.secondaryPosition) {
                    positionsText += `, P2: ${player.secondaryPosition}`;
                }
                playerDiv.innerHTML = `
                    <div class="flex items-center gap-4 w-full">
                        <span class="jersey-badge flex-shrink-0">${player.jerseyNumber || '-'}</span>
                        <div class="min-w-0">
                            <p class="font-bold text-lg">${player.name}</p>
                            <p class="text-sm text-gray-600">Licence: ${player.licenseNumber || 'N/A'}</p>
                        </div>
                    </div>
                    <div class="flex flex-col sm:flex-row items-end sm:items-center gap-2 mt-2 sm:mt-0 w-full sm:w-auto">
                         <div class="text-left sm:text-right w-full sm:w-auto">
                            <p class="text-sm font-medium text-gray-700">${positionsText}</p>
                         </div>
                        <div class="flex gap-2 self-end sm:self-center flex-shrink-0">
                            <button onclick="openEditPlayerModal(${player.id})" class="bg-yellow-500 text-white text-xs font-semibold py-1 px-2 rounded-lg hover:bg-yellow-600">Modifier</button>
                            <button onclick="deletePlayer(${player.id})" class="bg-red-500 text-white text-xs font-semibold py-1 px-2 rounded-lg hover:bg-red-600">X</button>
                        </div>
                    </div>
                `;
                playerListDiv.appendChild(playerDiv);
            });
        }


        // --- GESTION DES MATCHS ---
        function createMatch() {
            const currentTeam = getCurrentTeam();
            const date = document.getElementById('addMatchModal').querySelector('#matchDate').value;
            const opponent = document.getElementById('addMatchModal').querySelector('#opponentName').value.trim();
            const location = document.getElementById('addMatchModal').querySelector('input[name="matchLocation"]:checked').value;
            if (date && opponent) {
                const newMatch = { 
                    id: Date.now(), date, opponent, location, present: [], played: [], captainId: null,
                    score: {
                        myTeam: '', opponent: '',
                        sets: Array(5).fill(null).map(() => ({ myTeam: '', opponent: '' }))
                    },
                    substitutions: {},
                    faults: {},
                    faultTrackingMode: 'detailed', // 'detailed' ou 'simple'
                    forfeitStatus: 'none' // 'none', 'win', ou 'loss'
                };
                currentTeam.matches.push(newMatch);
                saveData();
                renderMatchSelector();
                document.getElementById('matchSelector').value = newMatch.id;
                document.getElementById('matchSelector').dispatchEvent(new Event('change'));
                closeModal('addMatchModal');
            } else {
                alert('Veuillez sélectionner une date et un adversaire.');
            }
        }
        
        function openEditMatchModal() {
            const matchId = parseInt(document.getElementById('matchSelector').value);
            const match = getCurrentTeam().matches.find(m => m.id === matchId);
            if (!match) return;
            const modal = document.getElementById('editMatchModal');
            modal.querySelector('#editMatchId').value = match.id;
            modal.querySelector('#editMatchDate').value = match.date;
            modal.querySelector('#editOpponentName').value = match.opponent;
            modal.querySelector(`input[name="editMatchLocation"][value="${match.location || 'domicile'}"]`).checked = true;
            modal.classList.remove('hidden');
        }
        
        function saveMatchChanges() {
            const matchId = parseInt(document.getElementById('editMatchModal').querySelector('#editMatchId').value);
            const match = getCurrentTeam().matches.find(m => m.id === matchId);
            if (!match) return;
            match.date = document.getElementById('editMatchModal').querySelector('#editMatchDate').value;
            match.opponent = document.getElementById('editMatchModal').querySelector('#editOpponentName').value.trim();
            match.location = document.getElementById('editMatchModal').querySelector('input[name="editMatchLocation"]:checked').value;
            saveData();
            renderMatchSelector();
            document.getElementById('matchSelector').value = matchId;
            closeModal('editMatchModal');
        }
        
        function deleteSelectedMatch() {
            const currentTeam = getCurrentTeam();
            const matchId = parseInt(document.getElementById('matchSelector').value);
            if (!matchId) return;
            if (confirm('Voulez-vous vraiment supprimer ce match ?')) {
                currentTeam.matches = currentTeam.matches.filter(m => m.id !== matchId);
                delete currentTeam.courtPositions[matchId];
                saveData();
                renderMatchSelector();
                document.getElementById('matchSelector').value = '';
                document.getElementById('matchSelector').dispatchEvent(new Event('change'));
            }
        }

        function renderMatchSelector() {
            const currentTeam = getCurrentTeam();
            const selector = document.getElementById('matchSelector');
            const currentVal = selector.value;
            selector.innerHTML = '<option value="">-- Sélectionnez un match --</option>';
            if(currentTeam && currentTeam.matches) {
                const sortedMatches = [...currentTeam.matches].sort((a, b) => new Date(b.date) - new Date(a.date));
                sortedMatches.forEach(match => {
                    const option = document.createElement('option');
                    option.value = match.id;
                    // La nouvelle ligne, beaucoup plus simple !
                    option.textContent = formatMatchTitle(match);
                    selector.appendChild(option);
                });
            }
            selector.value = currentVal;
        }

        function renderAttendanceForSelectedMatch() {
            const currentTeam = getCurrentTeam();
            const selector = document.getElementById('matchSelector');
            const matchId = parseInt(selector.value);
            const selectedMatchContentDiv = document.getElementById('selectedMatchContent');
            const attendanceList = document.getElementById('attendanceList');

            if (!matchId || !currentTeam) {
                selectedMatchContentDiv.classList.add('hidden');
                return;
            }

            const match = currentTeam.matches.find(m => m.id === matchId);
            if (!match) {
                 selectedMatchContentDiv.classList.add('hidden');
                 return;
            }

            // Render Attendance
            attendanceList.innerHTML = '';
            
            const matchSetCounts = {};
            currentTeam.players.forEach(player => { matchSetCounts[player.id] = 0; });
            
            SETS.forEach(setName => {
                const setLineup = currentTeam.courtPositions[matchId] ? currentTeam.courtPositions[matchId][setName] : null;
                const setSubs = match.substitutions ? match.substitutions[setName] : null;

                if (setLineup) {
                    Object.values(setLineup).forEach(playerId => {
                         if (matchSetCounts.hasOwnProperty(playerId)) matchSetCounts[playerId]++;
                    });
                }
                if (setSubs) {
                    setSubs.forEach(sub => {
                        if (matchSetCounts.hasOwnProperty(sub.in)) matchSetCounts[sub.in]++;
                    });
                }
            });


            const sortedPlayers = [...currentTeam.players].sort((a, b) => a.name.localeCompare(b.name));
            sortedPlayers.forEach(player => {
                const isPresent = match.present.includes(player.id);
                const isCaptain = match.captainId === player.id;
                const setCount = matchSetCounts[player.id] || 0;
                const playerRow = document.createElement('div');
                const genderClass = player.gender === 'F' ? 'bg-pink-100' : 'bg-blue-100';
                playerRow.className = `flex flex-wrap justify-between items-center py-2 px-3 ${genderClass} rounded-lg gap-2`;
                playerRow.innerHTML = `
                    <div class="flex items-center min-w-0">
                        <b class="w-8 inline-block flex-shrink-0">#${player.jerseyNumber || '-'}</b> 
                        <span class="font-medium">${player.name}</span>
                    </div>
                    <div class="flex items-center gap-2 sm:gap-4 flex-shrink-0 w-full sm:w-auto justify-end">
                        <span class="font-semibold text-gray-700 text-sm">${setCount} set(s)</span>
                        <label class="flex items-center gap-1 cursor-pointer" title="Capitaine">
                            <input type="checkbox" onchange="updateCaptain(this, ${matchId}, ${player.id})" ${isPresent ? '' : 'disabled'} ${isCaptain ? 'checked' : ''} class="captain-checkbox w-5 h-5 rounded-full text-yellow-500 focus:ring-0 focus:ring-offset-0">
                            <span class="text-sm">C</span>
                        </label>
                        <label class="flex items-center gap-1 sm:gap-2 cursor-pointer">
                            <input type="checkbox" onchange="updatePresence(${matchId}, ${player.id}, this.checked)" ${isPresent ? 'checked' : ''} class="w-5 h-5 rounded text-blue-500">
                            <span class="text-sm">Présent</span>
                        </label>
                    </div>`;
                attendanceList.appendChild(playerRow);
            });

            // Render other components
            renderCourt();
            renderScoreTracker(match);
            renderSubstitutions();
        }
        
        function updateCaptain(checkboxElem, matchId, playerId) {
            const currentTeam = getCurrentTeam();
            const match = currentTeam.matches.find(m => m.id === matchId);
            if (!match) return;

            document.querySelectorAll('.captain-checkbox').forEach(box => {
                if (box !== checkboxElem) {
                    box.checked = false;
                }
            });

            if (checkboxElem.checked) {
                match.captainId = playerId;
            } else {
                match.captainId = null;
            }

            saveData();
        }


        function renderScoreTracker(match) {
            const currentTeam = getCurrentTeam();
            document.getElementById('myTeamNameLabel').textContent = currentTeam.name;
            document.getElementById('opponentNameLabel').textContent = match.opponent;

            if (!match.score) {
                match.score = { myTeam: '', opponent: '', sets: Array(5).fill(null).map(() => ({ myTeam: '', opponent: '' })) };
            }
            if (!match.forfeitStatus) {
                match.forfeitStatus = 'none';
            }

            const setScoresContainer = document.getElementById('setScoresContainer');
            setScoresContainer.innerHTML = '';
            match.score.sets.forEach((set, index) => {
                const setRow = document.createElement('div');
                setRow.className = 'flex items-center justify-between';
                setRow.innerHTML = `
                    <label class="font-semibold">Set ${index + 1}</label>
                    <div class="flex items-center gap-2">
                        <input type="number" min="0" data-set-index="${index}" data-team="myTeam" class="set-score-input w-20 p-2 border border-gray-300 rounded-lg text-center" value="${set.myTeam || ''}">
                        <span>-</span>
                        <input type="number" data-set-index="${index}" data-team="opponent" class="set-score-input w-20 p-2 border border-gray-300 rounded-lg text-center" value="${set.opponent || ''}">
                    </div>
                `;
                setScoresContainer.appendChild(setRow);
            });
            
            updateFinalScore(match);

            document.querySelectorAll('.set-score-input').forEach(input => {
                input.oninput = updateScore;
            });

            // Gérer l'affichage des boutons de forfait
            const statusDisplay = document.getElementById('forfeit-status-display');
            const forfeitButtons = document.getElementById('forfeit-buttons');
            const cancelForfeitButton = document.getElementById('cancel-forfeit-button');
            const scoreInputs = document.querySelectorAll('.set-score-input');

            if (match.forfeitStatus === 'win' || match.forfeitStatus === 'loss') {
                statusDisplay.textContent = `Statut : ${match.forfeitStatus === 'win' ? 'Victoire' : 'Défaite'} par Forfait`;
                statusDisplay.className = `text-center font-semibold mb-2 ${match.forfeitStatus === 'win' ? 'text-green-600' : 'text-red-600'}`;
                statusDisplay.classList.remove('hidden');
                forfeitButtons.classList.add('hidden');
                cancelForfeitButton.classList.remove('hidden');
                scoreInputs.forEach(input => input.disabled = true);
            } else {
                statusDisplay.classList.add('hidden');
                forfeitButtons.classList.remove('hidden');
                cancelForfeitButton.classList.add('hidden');
                scoreInputs.forEach(input => input.disabled = false);
            }
        }
        
        function updateFinalScore(match) {
            let myTeamSetsWon = 0;
            let opponentSetsWon = 0;

            if (match.forfeitStatus !== 'none') {
                myTeamSetsWon = match.score.myTeam;
                opponentSetsWon = match.score.opponent;
            } else if (match.score && match.score.sets) {
                match.score.sets.forEach(set => {
                    const myTeamScore = parseInt(set.myTeam, 10);
                    const opponentScore = parseInt(set.opponent, 10);

                    if (!isNaN(myTeamScore) && !isNaN(opponentScore) && (myTeamScore > 0 || opponentScore > 0) ) {
                        if (myTeamScore > opponentScore) {
                            myTeamSetsWon++;
                        } else if (opponentScore > myTeamScore) {
                            opponentSetsWon++;
                        }
                    }
                });
                match.score.myTeam = myTeamSetsWon;
                match.score.opponent = opponentSetsWon;
            }
            
            document.getElementById('scoreMyTeam').value = myTeamSetsWon;
            document.getElementById('scoreOpponent').value = opponentSetsWon;
        }

function updateScore() {
    const currentTeam = getCurrentTeam();
    const matchId = parseInt(document.getElementById('matchSelector').value);
    if (!matchId || !currentTeam) return;

    const match = currentTeam.matches.find(m => m.id === matchId);
    if (!match) return;

    // Si le statut était "forfait", on le retire et on réactive les champs.
    if (match.forfeitStatus !== 'none') {
        match.forfeitStatus = 'none';
        // Met à jour l'interface des boutons de forfait sans tout redessiner
        document.getElementById('forfeit-status-display').classList.add('hidden');
        document.getElementById('forfeit-buttons').classList.remove('hidden');
        document.getElementById('cancel-forfeit-button').classList.add('hidden');
        document.querySelectorAll('.set-score-input').forEach(input => input.disabled = false);
    }

    // Met à jour les données du score en mémoire
    document.querySelectorAll('.set-score-input').forEach(input => {
        const setIndex = parseInt(input.dataset.setIndex);
        const team = input.dataset.team;
        match.score.sets[setIndex][team] = input.value;
    });

    // Recalcule le score final et sauvegarde
    updateFinalScore(match);
    saveData();
}

        function setForfeit(status) {
            const currentTeam = getCurrentTeam();
            const matchId = parseInt(document.getElementById('matchSelector').value);
            const match = currentTeam.matches.find(m => m.id === matchId);
            if (!match) return;

            match.forfeitStatus = status;

            if (status === 'win') {
                match.score.myTeam = 3;
                match.score.opponent = 0;
                match.score.sets = [
                    { myTeam: 25, opponent: 0 }, { myTeam: 25, opponent: 0 }, { myTeam: 25, opponent: 0 },
                    { myTeam: '', opponent: '' }, { myTeam: '', opponent: '' }
                ];
            } else if (status === 'loss') {
                match.score.myTeam = 0;
                match.score.opponent = 3;
                match.score.sets = [
                    { myTeam: 0, opponent: 25 }, { myTeam: 0, opponent: 25 }, { myTeam: 0, opponent: 25 },
                    { myTeam: '', opponent: '' }, { myTeam: '', opponent: '' }
                ];
            } else { // status === 'none'
                match.score.myTeam = '';
                match.score.opponent = '';
                match.score.sets = Array(5).fill(null).map(() => ({ myTeam: '', opponent: '' }));
            }
            
            saveData();
            renderScoreTracker(match);
            renderMatchSelector();
            renderResults();
        }

        function updatePresence(matchId, playerId, isChecked) {
            const currentTeam = getCurrentTeam();
            const match = currentTeam.matches.find(m => m.id === matchId);
            if (!match) return;
            if (isChecked) {
                if (!match.present.includes(playerId)) match.present.push(playerId);
            } else {
                match.present = match.present.filter(id => id !== playerId);
                if (match.captainId === playerId) {
                    match.captainId = null;
                }
                if (currentTeam.courtPositions[matchId]) {
                    SETS.forEach(set => {
                        if (currentTeam.courtPositions[matchId][set]) {
                            for (const pos in currentTeam.courtPositions[matchId][set]) {
                                if (currentTeam.courtPositions[matchId][set][pos] === playerId) {
                                    delete currentTeam.courtPositions[matchId][set][pos];
                                }
                            }
                        }
                    });
                }
                recalculatePlayedStatus(matchId);
            }
            saveData();
            renderAttendanceForSelectedMatch();
        }

        function renderSetSelector() {
            const selectors = [document.getElementById('set-selector-matches'), document.getElementById('set-selector-live')];
            selectors.forEach(selectorDiv => {
                if(!selectorDiv) return;
                selectorDiv.innerHTML = '';
                SETS.forEach((setName, index) => {
                    const button = document.createElement('button');
                    button.textContent = `Set ${index + 1}`;
                    button.className = `set-button flex-1 py-2 px-4 text-sm font-semibold rounded-md ${currentSet === setName ? 'active' : 'bg-white'}`;
                    button.onclick = () => selectSet(setName);
                    selectorDiv.appendChild(button);
                });
            });
        }

        function setCourtPositionColor(selectElement, playerId) {
            const currentTeam = getCurrentTeam();
            selectElement.classList.remove('bg-pink-100', 'bg-blue-100', 'bg-white');

            if (playerId && currentTeam) {
                const player = currentTeam.players.find(p => p.id === parseInt(playerId));
                if (player) {
                    selectElement.classList.add(player.gender === 'F' ? 'bg-pink-100' : 'bg-blue-100');
                    return;
                }
            }
            
            selectElement.classList.add('bg-white');
        }
        
function renderCourt() {
    const currentTeam = getCurrentTeam();
    const matchId = parseInt(document.getElementById('matchSelector').value);
    
    // S'il n'y a pas de match sélectionné, on ne fait rien.
    if (!matchId || !currentTeam) {
        for (let i = 1; i <= 6; i++) {
            const posDiv = document.getElementById(`pos-${i}`);
            const oldSelect = posDiv.querySelector('select');
            if (oldSelect) posDiv.removeChild(oldSelect);
        }
        return;
    }

    const match = currentTeam.matches.find(m => m.id === matchId);
    if (!match) return;

    // 1. On récupère la composition du set actuel et les ID des joueurs déjà placés.
    const matchSetPositions = currentTeam.courtPositions[matchId] ? (currentTeam.courtPositions[matchId][currentSet] || {}) : {};
    const selectedPlayerIds = Object.values(matchSetPositions);
    const presentPlayers = currentTeam.players.filter(p => match.present.includes(p.id));

    for (let i = 1; i <= 6; i++) {
        const posDiv = document.getElementById(`pos-${i}`);
        const positionKey = `pos-${i}`;
        
        const oldSelect = posDiv.querySelector('select');
        if (oldSelect) posDiv.removeChild(oldSelect);

        const select = document.createElement('select');
        select.className = 'player-select';
        select.dataset.position = positionKey;
        select.innerHTML = '<option value="">-- Choisir --</option>';

        // 2. On identifie le joueur actuellement sélectionné pour CE poste précis.
        const currentPlayerIdForThisPos = matchSetPositions[positionKey];
        
        presentPlayers.forEach(player => {
            
            // 3. On n'affiche un joueur dans la liste que si :
            //    a) C'est celui qui est déjà sélectionné pour ce poste, OU
            //    b) Il n'est sélectionné sur aucun autre poste.
            if (player.id === currentPlayerIdForThisPos || !selectedPlayerIds.includes(player.id)) {
                select.innerHTML += `<option value="${player.id}">${player.jerseyNumber || '#'}.${player.name}</option>`;
            }            
        });
        
        // La valeur sélectionnée est celle du joueur à ce poste.
        if (currentPlayerIdForThisPos) {
            select.value = currentPlayerIdForThisPos;
        }
        
        select.addEventListener('change', updatePosition);
        posDiv.appendChild(select);
        setCourtPositionColor(select, select.value);
    }
}

        function updatePosition(event) {
            const currentTeam = getCurrentTeam();
            const matchId = parseInt(document.getElementById('matchSelector').value);
            if (!matchId) return;
            const selectElement = event.target;
            const position = selectElement.dataset.position;
            const playerId = selectElement.value ? parseInt(selectElement.value) : null;
            
            if (!currentTeam.courtPositions[matchId]) currentTeam.courtPositions[matchId] = {};
            if (!currentTeam.courtPositions[matchId][currentSet]) currentTeam.courtPositions[matchId][currentSet] = {};

            if (playerId) {
                 currentTeam.courtPositions[matchId][currentSet][position] = playerId;
            } else {
                delete currentTeam.courtPositions[matchId][currentSet][position];
            }
            
            setCourtPositionColor(selectElement, playerId);
            recalculatePlayedStatus(matchId);
            renderAttendanceForSelectedMatch();
            renderSubstitutions();
            saveData();
        }
        
        function renderSubstitutions() {
            const subsList = document.getElementById('substitutionsList');
            const currentTeam = getCurrentTeam();
            const matchId = parseInt(document.getElementById('matchSelector').value);

            if (!subsList || !currentTeam || !matchId) {
                if(subsList) subsList.innerHTML = '';
                return;
            }

            const match = currentTeam.matches.find(m => m.id === matchId);
            if (!match || !match.substitutions || !match.substitutions[currentSet]) {
                subsList.innerHTML = '<p class="text-gray-500 text-sm">Aucun remplacement pour ce set.</p>';
                return;
            }

            subsList.innerHTML = '';
            match.substitutions[currentSet].forEach(sub => {
                const playerOut = currentTeam.players.find(p => p.id === sub.out)?.name || 'Inconnu';
                const playerIn = currentTeam.players.find(p => p.id === sub.in)?.name || 'Inconnu';
                const subDiv = document.createElement('div');
                subDiv.className = 'text-sm p-2 bg-gray-100 rounded';
                subDiv.textContent = `Entrée de ${playerIn} à la place de ${playerOut}`;
                subsList.appendChild(subDiv);
            });
        }

        function recalculatePlayedStatus(matchId) {
            const currentTeam = getCurrentTeam();
            const match = currentTeam.matches.find(m => m.id === matchId);
            if (!match) return;

            const playedIds = new Set();
            if (currentTeam.courtPositions[matchId]) {
                Object.values(currentTeam.courtPositions[matchId]).forEach(setLineup => {
                    Object.values(setLineup).forEach(playerId => playedIds.add(playerId));
                });
            }
            if (match.substitutions) {
                 Object.values(match.substitutions).forEach(setSubs => {
                    setSubs.forEach(sub => playedIds.add(sub.in));
                });
            }
            match.played = Array.from(playedIds);
        }

        function renderStats() {
            renderPlayerStats();
            renderTeamStats();
        }

        function renderPlayerStats() {
            const currentTeam = getCurrentTeam();
            const statsBody = document.getElementById('statsTableBody');
            statsBody.innerHTML = '';
            if (!currentTeam) return;

            const sortedPlayers = [...currentTeam.players].sort((a, b) => a.name.localeCompare(b.name));
            
            sortedPlayers.forEach(player => {
                let presenceCount = 0;
                let playedCount = 0;
                let setCount = 0;
                let setsWonCount = 0;
                let faultCounts = { service: 0, attack: 0, reception: 0, net: 0 };

                currentTeam.matches.forEach(match => {
                    if (match.present.includes(player.id)) presenceCount++;
                    if (match.played && match.played.includes(player.id)) playedCount++;

                    SETS.forEach((setName, index) => {
                        const setLineup = currentTeam.courtPositions[match.id] ? currentTeam.courtPositions[match.id][setName] : null;
                        
                        let playedInSet = setLineup && Object.values(setLineup).includes(player.id);
                        if (!playedInSet && match.substitutions && match.substitutions[setName]) {
                            playedInSet = match.substitutions[setName].some(sub => sub.in === player.id);
                        }

                        if (playedInSet) {
                            setCount++;
                            const setScore = match.score && match.score.sets ? match.score.sets[index] : null;
                            if (setScore && setScore.myTeam !== '' && setScore.opponent !== '' && parseInt(setScore.myTeam) > parseInt(setScore.opponent)) {
                                setsWonCount++;
                            }
                        }
                    });

                    if (match.faults) {
                        Object.values(match.faults).forEach(setFaults => {
                            if (setFaults[player.id]) {
                                const playerFaultsInSet = setFaults[player.id];
                                faultCounts.service += playerFaultsInSet.service || 0;
                                faultCounts.attack += playerFaultsInSet.attack || 0;
                                faultCounts.reception += playerFaultsInSet.reception || 0;
                                faultCounts.net += playerFaultsInSet.net || 0;
                            }
                        });
                    }
                });
                
                const totalFaults = faultCounts.service + faultCounts.attack + faultCounts.reception + faultCounts.net;

                const row = document.createElement('tr');
                row.className = 'border-b';
                row.innerHTML = `
                    <td class="p-3">${player.name}</td>
                    <td class="p-3 text-center">${presenceCount}</td>
                    <td class="p-3 text-center">${playedCount}</td>
                    <td class="p-3 text-center">${setCount}</td>
                    <td class="p-3 text-center">${setsWonCount}</td>
                    <td class="p-3 text-center">${faultCounts.service}</td>
                    <td class="p-3 text-center">${faultCounts.attack}</td>
                    <td class="p-3 text-center">${faultCounts.reception}</td>
                    <td class="p-3 text-center">${faultCounts.net}</td>
                    <td class="p-3 text-center font-bold">${totalFaults}</td>`;
                statsBody.appendChild(row);
            });
        }

        function renderTeamStats() {
            const currentTeam = getCurrentTeam();
            const statsRow = document.getElementById('teamStatsRow');
            statsRow.innerHTML = '';
            if (!currentTeam || !currentTeam.matches || currentTeam.matches.length === 0) {
                 statsRow.innerHTML = `<td colspan="14" class="p-4 text-center text-gray-500">Aucun match joué pour le moment.</td>`;
                 return;
            }

            let stats = {
                points: 0, joues: 0, gagnes: 0, perdus: 0,
                g30: 0, g31: 0, g32: 0, p23: 0, p13: 0, p03: 0,
                setsPour: 0, setsContre: 0, ptsPour: 0, ptsContre: 0
            };

            currentTeam.matches.forEach(match => {
                if (!match.score || (match.score.myTeam === '' && match.score.opponent === '' && match.forfeitStatus === 'none')) return;

                stats.joues++;

                if (match.forfeitStatus === 'win') {
                    stats.points += 3;
                    stats.gagnes++;
                    stats.g30++;
                    stats.setsPour += 3;
                    stats.ptsPour += 75;
                    return; // On passe au match suivant
                }
                if (match.forfeitStatus === 'loss') {
                    stats.points -= 1;
                    stats.perdus++;
                    stats.p03++;
                    stats.setsContre += 3;
                    stats.ptsContre += 75;
                    return; // On passe au match suivant
                }

                const mySets = parseInt(match.score.myTeam);
                const oppSets = parseInt(match.score.opponent);

                stats.setsPour += mySets;
                stats.setsContre += oppSets;
                
                if (match.score.sets) {
                    match.score.sets.forEach(set => {
                        stats.ptsPour += parseInt(set.myTeam) || 0;
                        stats.ptsContre += parseInt(set.opponent) || 0;
                    });
                }

                if (mySets > oppSets) {
                    stats.gagnes++;
                    if (mySets === 3 && oppSets === 0) { stats.points += 3; stats.g30++; }
                    else if (mySets === 3 && oppSets === 1) { stats.points += 3; stats.g31++; }
                    else if (mySets === 3 && oppSets === 2) { stats.points += 2; stats.g32++; }
                } else if (oppSets > mySets) {
                    stats.perdus++;
                    if (mySets === 2 && oppSets === 3) { stats.points += 1; stats.p23++; }
                    else if (mySets === 1 && oppSets === 3) { stats.p13++; }
                    else if (mySets === 0 && oppSets === 3) { stats.p03++; }
                }
            });

            statsRow.innerHTML = `
                <td class="p-2 font-bold">${stats.points}</td>
                <td class="p-2">${stats.joues}</td>
                <td class="p-2">${stats.gagnes}</td>
                <td class="p-2">${stats.perdus}</td>
                <td class="p-2">${stats.g30}</td>
                <td class="p-2">${stats.g31}</td>
                <td class="p-2">${stats.g32}</td>
                <td class="p-2">${stats.p23}</td>
                <td class="p-2">${stats.p13}</td>
                <td class="p-2">${stats.p03}</td>
                <td class="p-2">${stats.setsPour}</td>
                <td class="p-2">${stats.setsContre}</td>
                <td class="p-2">${stats.ptsPour}</td>
                <td class="p-2">${stats.ptsContre}</td>
            `;
        }

        // --- LIVE TRACKING (Refonte avec appui long) ---

        function addFaultButtonListeners(button, matchId, playerId, faultType) {
            let pressTimer;
            let longPressOccurred = false;
            let isScrolling = false;
            let startX, startY;

            const startPress = (e) => {
                isScrolling = false;
                longPressOccurred = false;
                startX = e.type === 'touchstart' ? e.touches[0].clientX : e.clientX;
                startY = e.type === 'touchstart' ? e.touches[0].clientY : e.clientY;
                
                button.classList.add('fault-btn-active');

                pressTimer = setTimeout(() => {
                    if (isScrolling) return; 
                    e.preventDefault(); 
                    longPressOccurred = true;
                    updateFault(matchId, playerId, faultType, -1);
                }, 500);
            };

            const movePress = (e) => {
                if (longPressOccurred || isScrolling) return;

                const moveX = e.type === 'touchmove' ? e.touches[0].clientX : e.clientX;
                const moveY = e.type === 'touchmove' ? e.touches[0].clientY : e.clientY;
                const diffX = Math.abs(startX - moveX);
                const diffY = Math.abs(startY - moveY);

                if (diffX > 5 || diffY > 5) { 
                    isScrolling = true;
                    clearTimeout(pressTimer);
                    button.classList.remove('fault-btn-active');
                }
            };

            const endPress = (e) => {
                clearTimeout(pressTimer);
                if (!longPressOccurred && !isScrolling) {
                    e.preventDefault(); 
                    updateFault(matchId, playerId, faultType, 1);
                }
                setTimeout(() => button.classList.remove('fault-btn-active'), 50);
            };
            
            button.addEventListener('mousedown', startPress);
            button.addEventListener('touchstart', startPress, { passive: true });

            button.addEventListener('mousemove', movePress);
            button.addEventListener('touchmove', movePress, { passive: true });

            button.addEventListener('mouseup', endPress);
            button.addEventListener('touchend', endPress);
            
            button.addEventListener('mouseleave', () => {
                clearTimeout(pressTimer);
                isScrolling = true;
                button.classList.remove('fault-btn-active');
            });
        }
        
        function renderLiveTrackingView() {
            const currentTeam = getCurrentTeam();
            const matchId = parseInt(document.getElementById('matchSelector').value);
            const liveContent = document.getElementById('live-content');
            const liveHint = document.getElementById('live-match-hint');
            const courtLayout = document.getElementById('live-court-layout');
            const toggle = document.getElementById('fault-mode-toggle');
            const liveMatchDisplay = document.getElementById('live-match-display');
            const liveMatchName = document.getElementById('live-match-name');

            document.getElementById('undo-last-fault').onclick = undoLastFault;
            
            if (!matchId || !currentTeam) {
                liveContent.classList.add('hidden');
                liveMatchDisplay.classList.add('hidden');
                liveHint.classList.remove('hidden');
                return;
            }
            
            liveHint.classList.add('hidden');
            liveMatchDisplay.classList.remove('hidden');
            liveContent.classList.remove('hidden');
            
            const match = currentTeam.matches.find(m => m.id === matchId);
            if (!match) return;

            // Afficher le nom du match sélectionné
            liveMatchName.textContent = formatMatchTitle(match);


            if (typeof match.faultTrackingMode === 'undefined') {
                match.faultTrackingMode = 'detailed';
            }

            toggle.checked = match.faultTrackingMode === 'detailed';
            toggle.onchange = () => {
                match.faultTrackingMode = toggle.checked ? 'detailed' : 'simple';
                saveData();
                renderLiveTrackingView();
            };

            renderSetSelector();
            
            courtLayout.innerHTML = '';
            const setLineup = (currentTeam.courtPositions[matchId] && currentTeam.courtPositions[matchId][currentSet]) || {};
            const lineupPlayerIds = Object.values(setLineup);

            if (lineupPlayerIds.length === 0) {
                courtLayout.innerHTML = `<p class="text-gray-500 col-span-2 text-center">Définissez le 6 de départ dans l'onglet "Matchs" pour commencer le suivi.</p>`;
                renderSetFaultsSummary(); // Afficher le résumé même sans joueur
                return;
            }

            lineupPlayerIds.forEach(playerId => {
                const player = currentTeam.players.find(p => p.id === playerId);
                if (player) {
                    let card;
                    if (match.faultTrackingMode === 'detailed') {
                        card = createPlayerCardLiveDetailed(match, player);
                        courtLayout.appendChild(card);
                        const faultTypes = ['service', 'attack', 'reception', 'net'];
                        faultTypes.forEach(type => {
                            const button = card.querySelector(`#fault-btn-${player.id}-${type}`);
                            addFaultButtonListeners(button, match.id, player.id, type);
                        });
                    } else {
                        card = createPlayerCardLiveSimple(match, player);
                        courtLayout.appendChild(card);
                        const button = card.querySelector(`#fault-btn-${player.id}-simple`);
                        addFaultButtonListeners(button, match.id, player.id, 'net'); // Le mode simple agit sur la faute "net" (Autres)
                    }
                }
            });

            renderSetFaultsSummary();
        }

        function createPlayerCardLiveDetailed(match, player) {
            const card = document.createElement('div');
            const genderClass = player.gender === 'F' ? 'bg-pink-100' : 'bg-blue-100';
            card.className = `live-player-card ${genderClass}`;

            const faults = (match.faults && match.faults[currentSet] && match.faults[currentSet][player.id]) 
                         || { service: 0, attack: 0, reception: 0, net: 0 };

            card.innerHTML = `
                <div class="font-bold cursor-pointer hover:text-blue-600 player-name-display" onclick="openSubstitutionModal(${player.id})">
                    #${player.jerseyNumber || '-'} ${player.name}
                </div>
                <div class="fault-grid">
                    <button id="fault-btn-${player.id}-service" class="fault-grid-btn">
                        Service: <span class="fault-count" id="fault-count-${player.id}-service">${faults.service}</span>
                    </button>
                    <button id="fault-btn-${player.id}-attack" class="fault-grid-btn">
                        Attaque: <span class="fault-count" id="fault-count-${player.id}-attack">${faults.attack}</span>
                    </button>
                    <button id="fault-btn-${player.id}-reception" class="fault-grid-btn">
                        Récep: <span class="fault-count" id="fault-count-${player.id}-reception">${faults.reception}</span>
                    </button>
                    <button id="fault-btn-${player.id}-net" class="fault-grid-btn">
                        Autres: <span class="fault-count" id="fault-count-${player.id}-net">${faults.net}</span>
                    </button>
                </div>
            `;
            return card;
        }

        function createPlayerCardLiveSimple(match, player) {
            const card = document.createElement('div');
            const genderClass = player.gender === 'F' ? 'bg-pink-100' : 'bg-blue-100';
            card.className = `live-player-card ${genderClass}`;

            const faults = (match.faults && match.faults[currentSet] && match.faults[currentSet][player.id]) 
                         || { service: 0, attack: 0, reception: 0, net: 0 };
            const totalFaults = Object.values(faults).reduce((a, b) => a + b, 0);

            card.innerHTML = `
                <div class="font-bold cursor-pointer hover:text-blue-600 player-name-display" onclick="openSubstitutionModal(${player.id})">
                    #${player.jerseyNumber || '-'} ${player.name}
                </div>
                <button id="fault-btn-${player.id}-simple" class="simple-fault-btn">
                    <span id="fault-count-${player.id}-simple">${totalFaults}</span>
                </button>
            `;
            return card;
        }

        function updateFault(matchId, playerId, faultType, change) {
            const currentTeam = getCurrentTeam();
            const match = currentTeam.matches.find(m => m.id === matchId);
            if (!match) return;

            if (!match.faults) match.faults = {};
            if (!match.faults[currentSet]) match.faults[currentSet] = {};
            if (!match.faults[currentSet][playerId]) match.faults[currentSet][playerId] = { service: 0, attack: 0, reception: 0, net: 0 };
            
            const currentFaults = match.faults[currentSet][playerId];
            let currentCount = currentFaults[faultType] || 0;

            if (change < 0 && currentCount === 0) {
                 return; // Ne pas passer en négatif
            }

            if (change > 0) {
                 appData.lastFaultAction = { matchId, playerId, faultType, set: currentSet };
            }

            currentCount += change;
            currentFaults[faultType] = currentCount;
            saveData();
            
            // Mise à jour instantanée de l'affichage
            const detailedCountSpan = document.getElementById(`fault-count-${playerId}-${faultType}`);
            if (detailedCountSpan) {
                detailedCountSpan.textContent = currentCount;
            }

            const simpleCountSpan = document.getElementById(`fault-count-${playerId}-simple`);
            if (simpleCountSpan) {
                const totalFaults = Object.values(currentFaults).reduce((a, b) => a + b, 0);
                simpleCountSpan.textContent = totalFaults;
            }
            renderSetFaultsSummary();
        }
        
        function undoLastFault() {
            if (!appData.lastFaultAction) {
                alert("Il n'y a pas de dernière faute à annuler.");
                return;
            }
            const { matchId, playerId, faultType, set } = appData.lastFaultAction;
            
            if (set !== currentSet) {
                 alert(`La dernière faute a été enregistrée sur le set ${set.replace('set','')}. Veuillez sélectionner ce set pour l'annuler.`);
                 return;
            }
            
            updateFault(matchId, playerId, faultType, -1);
            appData.lastFaultAction = null; // Important: on ne peut annuler qu'une fois
        }

        function openSubstitutionModal(playerIdToReplace) {
            const currentTeam = getCurrentTeam();
            const matchId = parseInt(document.getElementById('matchSelector').value);
            const match = currentTeam.matches.find(m => m.id === matchId);
            const playerToReplace = currentTeam.players.find(p => p.id === playerIdToReplace);

            document.getElementById('substitutionModalTitle').textContent = `Remplacer ${playerToReplace.name}`;
            
            const substitutesListDiv = document.getElementById('substitutesList');
            substitutesListDiv.innerHTML = '';

            const onCourtPlayerIds = Object.values(currentTeam.courtPositions[matchId][currentSet]);
            const availableSubstitutes = currentTeam.players.filter(p => match.present.includes(p.id) && !onCourtPlayerIds.includes(p.id));

            if (availableSubstitutes.length === 0) {
                substitutesListDiv.innerHTML = `<p class="text-gray-500">Aucun remplaçant disponible sur le banc.</p>`;
            } else {
                availableSubstitutes.forEach(sub => {
                    const subButton = document.createElement('button');
                    subButton.className = 'w-full text-left p-3 bg-gray-100 rounded-lg hover:bg-blue-100 transition';
                    subButton.innerHTML = `<span class="font-bold">#${sub.jerseyNumber || '-'}</span> ${sub.name}`;
                    subButton.onclick = () => executeSubstitution(playerIdToReplace, sub.id);
                    substitutesListDiv.appendChild(subButton);
                });
            }

            document.getElementById('substitutionModal').classList.remove('hidden');
        }

        function executeSubstitution(playerOutId, playerInId) {
            const currentTeam = getCurrentTeam();
            const matchId = parseInt(document.getElementById('matchSelector').value);
            const match = currentTeam.matches.find(m => m.id === matchId);
            
            const setLineup = currentTeam.courtPositions[matchId][currentSet];
            
            // Trouver le poste du joueur sortant pour le mettre à jour
            let positionToUpdate = null;
            for (const pos in setLineup) {
                if (setLineup[pos] === playerOutId) {
                    positionToUpdate = pos;
                    break;
                }
            }

            if (positionToUpdate) {
                // Mettre à jour la composition du terrain
                currentTeam.courtPositions[matchId][currentSet][positionToUpdate] = playerInId;
                
                // Enregistrer le remplacement
                if (!match.substitutions) match.substitutions = {};
                if (!match.substitutions[currentSet]) match.substitutions[currentSet] = [];
                match.substitutions[currentSet].push({ out: playerOutId, in: playerInId });

                recalculatePlayedStatus(matchId);
                saveData();
                closeModal('substitutionModal');
                renderLiveTrackingView();
                renderAttendanceForSelectedMatch();
            } else {
                alert("Erreur : Le joueur à remplacer n'a pas été trouvé sur le terrain.");
            }
        }

        function renderSetFaultsSummary() {
            const summaryDiv = document.getElementById('set-faults-summary');
            const currentTeam = getCurrentTeam();
            const matchId = parseInt(document.getElementById('matchSelector').value);
            if (!summaryDiv || !currentTeam || !matchId) return;

            const match = currentTeam.matches.find(m => m.id === matchId);
            if (!match || !match.faults) {
                summaryDiv.innerHTML = '';
                return;
            }

            let totalMatchFaults = 0;
            let summaryHtml = '<h4 class="text-lg font-semibold mb-2 text-center">Total des Fautes par Set</h4><div class="space-y-1">';

            SETS.forEach((setName, index) => {
                let setTotal = 0;
                if (match.faults[setName]) {
                    for (const playerId in match.faults[setName]) {
                        setTotal += Object.values(match.faults[setName][playerId]).reduce((a, b) => a + b, 0);
                    }
                }
                summaryHtml += `<p class="text-sm text-gray-700 text-center">Set ${index + 1}: <span class="font-bold text-lg">${setTotal}</span></p>`;
                totalMatchFaults += setTotal;
            });

            summaryHtml += '</div><p class="text-md font-bold mt-3 border-t pt-2 text-center">Total Match: ' + totalMatchFaults + '</p>';
            summaryDiv.innerHTML = summaryHtml;
        }

        function renderResults() {
            const currentTeam = getCurrentTeam();
            const resultsTableBody = document.getElementById('results-list-table');
            const summaryDiv = document.getElementById('results-summary');
            resultsTableBody.innerHTML = '';
            summaryDiv.innerHTML = '';

            if (!currentTeam || !currentTeam.matches || currentTeam.matches.length === 0) {
                resultsTableBody.innerHTML = '<tr><td colspan="5" class="p-4 text-center text-gray-500">Aucun match enregistré pour cette équipe.</td></tr>';
                summaryDiv.innerHTML = `<h3 class="text-xl font-bold">Synthèse : 0 victoires sur 0 matchs joués</h3>`;
                return;
            }

            const sortedMatches = [...currentTeam.matches].sort((a, b) => new Date(a.date) - new Date(b.date));

            let totalPlayed = 0;
            let totalWins = 0;

            sortedMatches.forEach(match => {
                const mySets = parseInt(match.score.myTeam);
                const oppSets = parseInt(match.score.opponent);
                
                const isPlayed = match.forfeitStatus !== 'none' || (!isNaN(mySets) && !isNaN(oppSets) && (mySets > 0 || oppSets > 0));
                
                let resultText = 'À Jouer';
                let resultColor = 'text-gray-500';
                let isWin = false;

                if (isPlayed) {
                    totalPlayed++;
                    if (match.forfeitStatus === 'win') {
                        isWin = true;
                    } else if (match.forfeitStatus === 'loss') {
                        isWin = false;
                    } else {
                        isWin = mySets > oppSets;
                    }

                    if (isWin) {
                        totalWins++;
                        resultText = 'Victoire';
                        resultColor = 'text-green-600';
                    } else {
                        resultText = 'Défaite';
                        resultColor = 'text-red-600';
                    }
                     if (match.forfeitStatus !== 'none') {
                        resultText += ' (F)';
                    }
                }
                
                let setScoresHtml = '';
                if(match.score && match.score.sets) {
                    match.score.sets.forEach((set) => {
                        if(set.myTeam !== '' || set.opponent !== '') {
                             setScoresHtml += `<span class="whitespace-nowrap text-xs px-2 py-1 bg-gray-200 rounded">${set.myTeam}-${set.opponent}</span>`;
                        }
                    });
                }

                const row = document.createElement('tr');
                row.className = 'border-b';
                row.innerHTML = `
                    <td class="p-3 text-sm text-gray-600">${new Date(match.date.replace(/-/g, '/')).toLocaleDateString('fr-FR')}</td>
                    <td class="p-3 font-medium">${match.opponent}</td>
                    <td class="p-3 text-center text-sm">${match.location === 'domicile' ? 'Dom.' : 'Ext.'}</td>
                    <td class="p-3 text-center font-bold ${resultColor}">${mySets || '0'}-${oppSets || '0'}</td>
                    <td class="p-3 flex gap-1">${setScoresHtml || '<span class="text-xs text-gray-500">N/A</span>'}</td>
                `;
                resultsTableBody.appendChild(row);
            });

            summaryDiv.innerHTML = `<h3 class="text-xl font-bold">Synthèse : <span class="text-green-600">${totalWins}</span> victoires sur <span class="font-bold">${totalPlayed}</span> matchs joués</h3>`;
        }
		
		function formatMatchTitle(match) {
    if (!match) return '';
    const date = new Date(match.date.replace(/-/g, '/')).toLocaleDateString('fr-FR');
    const location = match.location === 'domicile' ? '(Dom.)' : '(Ext.)';

    let scoreText = '';
    if (match.forfeitStatus === 'win') {
        scoreText = ' [Forfait G]';
    } else if (match.forfeitStatus === 'loss') {
        scoreText = ' [Forfait P]';
    }

    return `Match du ${date} vs ${match.opponent} ${location}${scoreText}`;
}  
    </script>
</body>
</html>


